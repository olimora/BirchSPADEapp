library(spade)
library(flowCore)

run_SPADE = function(input_file, output_dir, markers, 
                     target_pctile, target_percent, target_number, exclude_pctile,
                     number_clusters) 
  {
  folder = "/home/DATA/BIOINF-DATA/P4/created-from-viable-population-for-analyses/"
  input_file_full = paste0(folder, '/', input_file)
  input_file_last = sub("^.+/", "", input_file)
  
  output_dir_full = paste0("/home/moravcik/try_spade/outputs_app/", output_dir)

  PANELS <- list(list(panel_files=c(input_file_last),
                      median_cols=NULL,
                      reference_files=c(input_file_last),
                      fold_cols=c()))

  SPADE.driver(input_file_full,
               out_dir=output_dir_full,
               cluster_cols=markers,
               panels=PANELS,
               transforms=flowCore::arcsinhTransform(a=0, b=0.2),
               layout=SPADE.layout.arch,
               downsampling_target_percent=NULL,
               downsampling_target_number=NULL,
               downsampling_target_pctile=0.03,
               downsampling_exclude_pctile=0.01,
               k=number_clusters,
               clustering_samples=50000)
  
  # # visualisation
  # layout <- read.table(file.path(output_dir_full,"layout.table"))
  # mst <- read.graph(file.path(output_dir_full,"mst.gml"),format="gml")
  # SPADE.plot.trees(mst,output_dir_full,
  #                  file_pattern="*fcs*Rsave",
  #                  layout=as.matrix(layout),
  #                  out_dir=file.path(output_dir_full,"pdf"),
  #                  size_scale_factor=1.2)
  
}
